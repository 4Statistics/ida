<style>@import url(style.css);</style>
[Introduction to Data Analysis](index.html "Course index")

# 10. Visualization in space: Maps

Let's [stick some data on a map][ds-map].

[ds-map]: http://is-r.tumblr.com/post/35200999886/make-your-own-electoral-map

```{r packages, message = FALSE, warning = FALSE}
# Load packages.
packages <- c("countrycode", "downloader", "foreign", "ggplot2", "maps", "RColorBrewer")
packages <- lapply(packages, FUN = function(x) {
  if(!require(x, character.only = TRUE)) {
    install.packages(x)
    library(x, character.only = TRUE)
  }
})
```

We will use [Quality of Government][qog] data, for which the country codes are standardized, and a rather old map of the world where a few countries need to be renamed to be matched to QOG country names. 

[qog]: http://www.qog.pol.gu.se/

```{r qog-data}
# Get world map coordinates from the maps package.
w <- map_data("world", zoom = 4)
# Fix a few country names.
w$region[which(w$region == "USA")] = "United States"
w$region[which(w$region == "UK")] = "United Kingdom"
w$region[which(w$region == "USSR")] = "Russia"
w$region[which(w$region == "Zaire")] = "Congo, Democratic Republic"
w$region[which(w$region == "North Korea")] = "Korea, North"
w$region[which(w$region == "South Korea")] = "Korea, South"
# Remove Antarctica.
w <- subset(w, !region %in% c("Antarctica", "Greenland"))
# Download Quality of Government Standard dataset.
link = "http://www.qogdata.pol.gu.se/data/qog_std_cs.dta"
file = "data/qog.cs.dta"
data = "data/qog.cs.txt"
if(!file.exists(data)) {
  if(!file.exists(file)) download(link, file, mode = "wb")
  write.csv(read.dta(file), data)
}
# Read local copy.
qog <- read.csv(data, stringsAsFactors = FALSE)
```

Here's a quick function to plot Quality of Government data. The first part extracts a variabl based on the argument passed to the function, along with (cleaned up) country names. The second part matches this data to the map, based on the `region` identifier of the world map data. The ast part plots the data by longitude and latitude, using a 'whitened' `ggplot2` theme.

```{r qog-map, tidy = FALSE}
qog.map <- function(x) {
  # Extract QOG variables.
  data <- with(qog, data.frame(
    country = gsub(" (\\(.*)", "", cname),
    variable = qog[, which(names(qog) == x)]))
  # Match QOG data to map.
  w$fill <- with(data, by(variable, country, mean))[w$region]
  set1 = brewer.pal(9, "Set1")
  # Plot over blank theme.
  p = qplot(data = w, x = long, y = lat,
            group = group, fill = fill, geom = "polygon")
  p = p + scale_fill_gradient2("",
                               low = set1[1], mid = set1[6], high = set1[3], 
                               midpoint = mean(w$fill, na.rm = TRUE),
                               na.value = set1[9])
  p = p + theme(axis.text = element_blank(),
                axis.ticks = element_blank(),
                panel.grid = element_blank())
  p = p + labs(y = NULL, x = NULL)
  return(p)  
}
```

You can pass any QOG variable name to the function, although its matching method will only support continuous variables, as shown below with an additive index of human rights by [Cingranelli and Richards][ciri]. The default color [gradient][ggplot2-gradient] uses [ColorBrewer][cb]'s `Set1` scheme and goes from green (low) to yellow (at midpoint) to red (high) by default.

[ciri]: http://www.humanrightsdata.org/
[cb]: http://colorbrewer2.org/

```{r qog-map-example-1-auto, fig.width = 12, fig.height = 6.6, tidy = FALSE}
# Plot a simple QOG map.
qog.map("ciri_empinx_new") + 
  labs(title = "CIRI Empowerment Rights Index (0-14) in 2009")
```

You can bypass the function's colors by overriding its `ggplot2` fill scale. The example below uses a color gradient of [Crayola colors][sss-crayola] that were coded for R by Matt Blackwell (check out Harvard's Social Science Statistics blog for other goodies, like this [elementary Google Maps][sss-googlemap] function by Andy Eggers).

[ggplot2-gradient]: http://docs.ggplot2.org/current/scale_gradient.html
[sss-crayola]: http://blogs.iq.harvard.edu/sss/archives/2011/02/crayola_colors.shtml
[sss-googlemap]: http://blogs.iq.harvard.edu/sss/archives/2008/04/google_charts_f_1.shtml

```{r qog-map-example-2-auto, fig.width = 12, fig.height = 6.6, tidy = FALSE, message = FALSE}
# Get Crayola colors from a personal copy.
url = "https://raw.github.com/gist/5813759"
source_url(url, prompt = FALSE)
# Plot with Crayola color gradient.
qog.map("wdi_the") + 
  labs(title = "Total health expenditure (% of GDP) in 2009") +
  scale_fill_gradient2("", 
                       low = crayola["Blue Green"], 
                       high = crayola["Sunset Orange"], 
                       mid = crayola["Yellow"], 
                       midpoint = mean(qog$wdi_the, na.rm = TRUE), 
                       na.value = crayola["Gray"])
```

> __Next__: [Geocoding](101_geocoding.html).
