<style>@import url(style.css);</style>
<small>[Introduction to Data Analysis](index.html)</small>

# 9.2. Smoothing

Looking at [smoothed splines](http://www.johnmarquess.com/?p=111).

## Assault deaths in the United States

Let's start with assault deaths in the United States. The data are from the [Bureau of Justice Statistics](http://bjs.ojp.usdoj.gov/). It got shared on the Reddit `/r/datasets/` channel in early 2013 and is saved as `bjs2007.csv` in the `/data/` folder. If not, the routine below will downlod the data and save it for you.

```{r bjs-data}
library(RCurl)
library(ggplot2)
library(reshape)

if(!file.exists("data/bjs2007.csv")) {
  # Get raw data.
  bjs <- getURL("https://raw.github.com/briatte/ida/master/data/bjs2007.csv")
  # Turn to text.
  bjs <- textConnection("/Users/fr/Downloads/weaponstab.csv")
  # Read lines.
  bjs <- readLines(bjs)
  # Check for folder.
  if(!file.exists("data")) dir.create("data")
  # Save as CSV.
  write.csv(bjs, file = "data/bjs2007.csv", row.names = FALSE, eol = "\r")
}

# Read as CSV.
bjs.data <- read.csv("data/bjs2007.csv")
# Check first rows.
head(bjs.data)
# Check final rows.
tail(bjs.data)
```

The plot is easy to set up with `ggplot2`. First, reshape the data to long format (one unit, one group, one value). Then, rename the columns to variable names. Last, plot one coored line per weapon used category.

```{r bjs-plot}
# Reshape to long format.
bjs <- melt(bjs.data, id = "Year")
# Check result.
head(bjs)
# Rename variables.
names(bjs) <- c("Year", "Weapon", "Count")
# Check result.
head(bjs)
# Plot by weapon type.
ggplot(bjs, aes(y = Count, x = Year)) + geom_line(aes(color = Weapon))
```

Let's smooth the series. We build a x-y canvas that will plot each weapon type in a different color and add a smoothed curve to it, using a [LOWESS function](https://en.wikipedia.org/wiki/Local_regression).

```{r -bjs-loess}
# Plot canvas.
fig <- ggplot(bjs, aes(y = Count, x = Year, group = Weapon, color = Weapon, fill = Weapon))
# Add a LOESS curve.
fig + geom_smooth()
# Add data points.
fig + geom_smooth() + geom_point()
```

A different smoother relies on the basic cubic spline of the series (see `?ns` for details).

```{r spline}
# Load splines package.
library(splines)
# A different smoother.
fig <- fig + geom_smooth(method="rlm", formula = y ~ ns(x,3))
# A different theme.
fig + theme_bw()
```

For state-by-state and OECD vs. USA comparative data, see [Kieran Healy's plots](https://github.com/kjhealy/assault-deaths).

```{r}
# Discriminate guns.
bjs$dummy <- ifelse(bjs$Weapon %in% c("Handgun","Other.gun"), "Guns", "Else")
```

## Assault deaths in South America

We now swtich to UNODC data for South America.

```{r bjs-data}
if(!file.exists("data/unodc2010.csv")) {
  # Get raw data.
  unodc <- getURL("http://www.quantumforest.com/wp-content/uploads/2012/02/homicides.csv")
  # Turn to text.
  unodc <- textConnection(unodc)
  # Save as CSV.
  write.table(unodc, file = "data/unodc2010.csv", row.names = FALSE)
}

# Read as CSV.
unodc.data <- read.csv("data/unodc2010.csv", sep = " ")
# Check first rows.
head(unodc.data)
# Check final rows.
tail(unodc.data)
```

http://www.quantumforest.com/wp-content/uploads/2012/02/homicides.csv

[intentional homicide rates in South America](http://www.quantumforest.com/2012/02/revisiting-homicide-rates/).

> __Next week__: [Visualization in space: Maps](100_maps.html).
